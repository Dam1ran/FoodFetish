import{a as S}from"./chunk-UEJSXAPY.js";import{a as D}from"./chunk-KUZ52WNQ.js";import{b as d,c as y,v as w,w as T}from"./chunk-G7KJV4CT.js";import{X as h,a as o,aa as l,b as v,ra as c}from"./chunk-HXGKTDM5.js";var p=class i{toasts=c([]);toastMessageTypeDefinitions={error:{className:"bg-danger-subtle"},warning:{className:"bg-warning-subtle"},success:{className:"bg-success-subtle"},information:{className:"bg-info-subtle"}};showAsError(e,t){this.show(o({id:d(),textOrTpl:e,toastType:"error"},t))}showAsWarning(e,t){this.show(o({id:d(),textOrTpl:e,toastType:"warning"},t))}showAsSuccess(e,t){this.show(o({id:d(),textOrTpl:e,toastType:"success"},t))}showAsInformation(e,t){this.show(o({id:d(),textOrTpl:e,toastType:"information"},t))}show(e){if(!e.textOrTpl)return;let t=e.toastType??"information";this.toasts.update(s=>[...s,o({id:d(),className:this.toastMessageTypeDefinitions[t].className,headerText:t},e)])}remove(e){this.toasts.update(t=>t.filter(s=>s!==e))}clear(){this.toasts.update(e=>e.filter(t=>t?.isClearIgnored))}static \u0275fac=function(t){return new(t||i)};static \u0275prov=h({token:i,factory:i.\u0275fac,providedIn:"root"})};var u=class extends Error{constructor(t,s){super(t);this.status=s}};async function g(i){if(!i.ok){let e=await i.text().catch(()=>"");throw new u(e||i.statusText,i.status)}}var x="875660427890-lqom4d5625fslef32gvcrlc972qefi13.apps.googleusercontent.com",F="https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/userinfo.email",k="food-fetish-data.json",A=class i{foodsService=l(y);recipesService=l(T);diaryLogService=l(w);optionsService=l(S);imageStoreService=l(D);toastsService=l(p);accessToken=null;tokenClient=null;isSignedIn=c(!1);isSyncing=c(!1);syncFailed=c(!1);userEmail=c(null);gisLoaded=!1;constructor(){this.restoreToken()}restoreToken(){let e=localStorage.getItem("google_token_data");if(e){let t=JSON.parse(e);this.isTokenExpired(t.expiry)?this.clearToken():(this.accessToken=t.token,this.userEmail.set(t.email??null),this.isSignedIn.set(!0))}}saveToken(e,t,s){let a={token:e};t&&(a.expiry=Date.now()+t*1e3),s&&(a.email=s),localStorage.setItem("google_token_data",JSON.stringify(a))}isTokenExpired(e){return e?Date.now()>e:!1}clearToken(){localStorage.removeItem("google_token_data")}delay(e){return new Promise(t=>setTimeout(t,e))}loadGisScript(){return this.gisLoaded?Promise.resolve():new Promise((e,t)=>{if(document.querySelector('script[src*="accounts.google.com/gsi/client"]')){this.gisLoaded=!0,e();return}let s=document.createElement("script");s.src="https://accounts.google.com/gsi/client",s.async=!0,s.defer=!0,s.onload=()=>{this.gisLoaded=!0,e()},s.onerror=()=>t(new Error("Failed to load Google Identity Services")),document.head.appendChild(s)})}async signIn(){try{await this.loadGisScript()}catch{this.toastsService.showAsError("Failed to load Google services",{headerText:null,delayMs:5e3});return}return new Promise(e=>{this.tokenClient=google.accounts.oauth2.initTokenClient({client_id:x,scope:F,callback:async t=>{if(t.error){this.toastsService.showAsError("Google sign-in failed",{headerText:null,delayMs:5e3}),e();return}if(this.accessToken=t.access_token??null,this.accessToken){let s=await this.getUserEmail(this.accessToken);this.userEmail.set(s??null),this.saveToken(this.accessToken,t.expires_in,s)}this.isSignedIn.set(!0),this.toastsService.showAsSuccess("Signed in to Google Drive",{headerText:null,delayMs:3e3}),await this.sync(),e()}}),this.tokenClient.requestAccessToken()})}signOut(){this.accessToken=null,this.userEmail.set(null),this.clearToken(),this.isSignedIn.set(!1),this.toastsService.showAsInformation("Signed out from Google Drive",{headerText:null,delayMs:3e3})}async uploadToDrive(){if(!this.accessToken){this.toastsService.showAsWarning("Not signed in to Google Drive",{headerText:null,delayMs:5e3});return}this.isSyncing.set(!0);try{let e=await this.gatherData(),t=await this.findDataFile(),s=0;t?(await this.updateFile(t,e),s=e.metadata?.version??0):await this.createFile(e);let a=this.getLocalVersion();if(s>a){this.toastsService.showAsError("Data on Google Drive is newer than local version.",{headerText:null,delayMs:5e3});return}e.metadata?.version&&this.setLocalVersion(e.metadata.version),this.toastsService.showAsSuccess("Data uploaded to Google Drive",{headerText:null,delayMs:3e3})}catch(e){console.error("Upload failed:",e),this.isAuthError(e)?this.handleAuthError():this.toastsService.showAsError("Failed to upload to Google Drive",{headerText:null,delayMs:5e3})}finally{this.isSyncing.set(!1)}}async downloadFromDrive(){if(!this.accessToken){this.toastsService.showAsWarning("Not signed in to Google Drive",{headerText:null,delayMs:5e3});return}this.isSyncing.set(!0);try{let e=await this.findDataFile();if(!e){this.toastsService.showAsWarning("No data found on Google Drive",{headerText:null,delayMs:5e3});return}let t=await this.downloadFile(e);await this.restoreData(t),t.metadata?.version&&this.setLocalVersion(t.metadata.version),this.toastsService.showAsSuccess("Data downloaded from Google Drive",{headerText:null,delayMs:3e3})}catch(e){console.error("Download failed:",e),this.isAuthError(e)?this.handleAuthError():this.toastsService.showAsError("Failed to download from Google Drive",{headerText:null,delayMs:5e3})}finally{this.isSyncing.set(!1)}}async sync(){if(this.syncFailed.set(!1),!(!this.accessToken||this.isSyncing())){this.isSyncing.set(!0);try{let e=await this.findDataFile();await this.delay(1e3);let t=this.getLocalVersion(),s=null;if(e)s=await this.downloadFile(e),await this.delay(1e3);else{let a=await this.gatherData();t++,a.metadata={version:t},await this.createFile(a),this.setLocalVersion(t);return}if((s.metadata?.version??0)>t){await this.restoreData(s),this.setLocalVersion(s.metadata.version);return}else{t++,this.setLocalVersion(t),await this.updateFile(e,v(o({},await this.gatherData()),{metadata:{version:t}}));return}}catch(e){this.isAuthError(e)?this.handleAuthError():(console.warn("GD sync failed"),this.toastsService.showAsError("Failed to sync with Google Drive",{headerText:null,delayMs:5e3})),this.syncFailed.set(!0)}finally{this.isSyncing.set(!1)}}}async gatherData(){let e=this.foodsService.foods(),t=this.recipesService.recipes(),s=this.diaryLogService.diaryLog(),a=this.optionsService.options(),m=new Set;for(let r of t)r.imageId&&m.add(r.imageId);if(s?.diaryDays)for(let r of s.diaryDays)for(let n of r.dayTemplate.entries)n.meal.imageId&&m.add(n.meal.imageId);let f=[];for(let r of m){let n=await this.imageStoreService.get(r);n&&(n=n.replace(/^data:image\/\w+;base64,/,""),f.push({imageId:r,base64:n}))}return{foods:e,recipes:t,diaryLog:s,options:a,images:f}}async restoreData(e){await this.imageStoreService.deleteDatabase().then(async()=>{if(e.images)for(let t of e.images)await this.imageStoreService.put(t.imageId,t.base64)}),this.foodsService.setFoods([]),this.recipesService.setRecipes([]),this.diaryLogService.setDiary({diaryDays:[]}),e.foods&&this.foodsService.setFoods(e.foods),e.recipes&&this.recipesService.setRecipes(e.recipes),e.diaryLog&&this.diaryLogService.setDiary(e.diaryLog),e.options&&this.optionsService.setOptions(e.options)}async findDataFile(){let e=await fetch(`https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&q=name='${k}'&fields=files(id,name)`,{headers:{Authorization:`Bearer ${this.accessToken}`}});return await g(e),(await e.json()).files?.[0]?.id??null}async createFile(e){let t={name:k,parents:["appDataFolder"],mimeType:"application/json"},s=new FormData;s.append("metadata",new Blob([JSON.stringify(t)],{type:"application/json"})),s.append("file",new Blob([JSON.stringify(e)],{type:"application/json"}));let a=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`},body:s});await g(a)}async updateFile(e,t){let s=await fetch(`https://www.googleapis.com/upload/drive/v3/files/${e}?uploadType=media`,{method:"PATCH",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify(t)});await g(s)}async downloadFile(e){let t=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?alt=media`,{headers:{Authorization:`Bearer ${this.accessToken}`}});return await g(t),t.json()}isAuthError(e){return e instanceof u&&e.status===401}handleAuthError(){this.accessToken=null,this.userEmail.set(null),this.clearToken(),this.isSignedIn.set(!1),this.toastsService.showAsWarning("Google session expired. Please sign in again.",{headerText:null,delayMs:5e3})}async getUserEmail(e){try{let t=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${e}`}});return t.ok?(await t.json()).email:void 0}catch{return}}getLocalVersion(){let e=localStorage.getItem("google_data_version");return e?parseInt(e):0}setLocalVersion(e){localStorage.setItem("google_data_version",e.toString())}static \u0275fac=function(t){return new(t||i)};static \u0275prov=h({token:i,factory:i.\u0275fac,providedIn:"root"})};export{p as a,A as b};
