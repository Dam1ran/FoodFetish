import{a as E}from"./chunk-FVGU5N2M.js";import{a as J}from"./chunk-UEJSXAPY.js";import{a as I}from"./chunk-2KTHP7SW.js";import{a as x,e as W,f as $,r as B,u as T,v as k}from"./chunk-KHSIFIAT.js";import"./chunk-P7OX43DN.js";import{l as G,t as z}from"./chunk-MAWMYTZY.js";import"./chunk-TTUD5ZDE.js";import{Fb as m,Ga as v,Hb as y,Ob as U,Pb as P,Qb as _,Ub as j,Vb as l,Wb as N,X as O,Xa as V,Xb as b,aa as p,fa as u,fc as M,ga as g,jb as C,kb as R,pb as h,qb as n,ra as S,rb as r,sc as D,yb as w}from"./chunk-HXGKTDM5.js";var A=class extends Error{constructor(t,i){super(t);this.status=i}};async function F(c){if(!c.ok){let e=await c.text().catch(()=>"");throw new A(e||c.statusText,c.status)}}var X="875660427890-lqom4d5625fslef32gvcrlc972qefi13.apps.googleusercontent.com",Y="https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/userinfo.email",q="food-fetish-data.json",L=class c{foodsService=p(x);recipesService=p(k);diaryLogService=p(T);optionsService=p(J);imageStoreService=p(I);toastsService=p(E);accessToken=null;tokenClient=null;isSignedIn=S(!1);isSyncing=S(!1);userEmail=S(null);gisLoaded=!1;constructor(){this.restoreToken()}restoreToken(){let e=localStorage.getItem("google_token_data");if(e){let t=JSON.parse(e);this.isTokenExpired(t.expiry)?this.clearToken():(this.accessToken=t.token,this.userEmail.set(t.email??null),this.isSignedIn.set(!0))}}saveToken(e,t,i){let o={token:e};t&&(o.expiry=Date.now()+t*1e3),i&&(o.email=i),localStorage.setItem("google_token_data",JSON.stringify(o))}isTokenExpired(e){return e?Date.now()>e:!1}clearToken(){localStorage.removeItem("google_token_data")}loadGisScript(){return this.gisLoaded?Promise.resolve():new Promise((e,t)=>{if(document.querySelector('script[src*="accounts.google.com/gsi/client"]')){this.gisLoaded=!0,e();return}let i=document.createElement("script");i.src="https://accounts.google.com/gsi/client",i.async=!0,i.defer=!0,i.onload=()=>{this.gisLoaded=!0,e()},i.onerror=()=>t(new Error("Failed to load Google Identity Services")),document.head.appendChild(i)})}async signIn(){try{await this.loadGisScript()}catch{this.toastsService.showAsError("Failed to load Google services",{headerText:null,delayMs:5e3});return}return new Promise(e=>{this.tokenClient=google.accounts.oauth2.initTokenClient({client_id:X,scope:Y,callback:async t=>{if(t.error){this.toastsService.showAsError("Google sign-in failed",{headerText:null,delayMs:5e3}),e();return}if(this.accessToken=t.access_token??null,this.accessToken){let i=await this.getUserEmail(this.accessToken);this.userEmail.set(i??null),this.saveToken(this.accessToken,t.expires_in,i)}this.isSignedIn.set(!0),this.toastsService.showAsSuccess("Signed in to Google Drive",{headerText:null,delayMs:3e3}),e()}}),this.tokenClient.requestAccessToken()})}signOut(){this.accessToken=null,this.userEmail.set(null),this.clearToken(),this.isSignedIn.set(!1),this.toastsService.showAsInformation("Signed out from Google Drive",{headerText:null,delayMs:3e3})}async uploadToDrive(){if(!this.accessToken){this.toastsService.showAsWarning("Not signed in to Google Drive",{headerText:null,delayMs:5e3});return}this.isSyncing.set(!0);try{let e=await this.gatherData(),t=await this.findDataFile();t?await this.updateFile(t,e):await this.createFile(e),this.toastsService.showAsSuccess("Data uploaded to Google Drive",{headerText:null,delayMs:3e3})}catch(e){console.error("Upload failed:",e),this.isAuthError(e)?this.handleAuthError():this.toastsService.showAsError("Failed to upload to Google Drive",{headerText:null,delayMs:5e3})}finally{this.isSyncing.set(!1)}}async downloadFromDrive(){if(!this.accessToken){this.toastsService.showAsWarning("Not signed in to Google Drive",{headerText:null,delayMs:5e3});return}this.isSyncing.set(!0);try{let e=await this.findDataFile();if(!e){this.toastsService.showAsWarning("No data found on Google Drive",{headerText:null,delayMs:5e3});return}let t=await this.downloadFile(e);await this.restoreData(t),this.toastsService.showAsSuccess("Data downloaded from Google Drive",{headerText:null,delayMs:3e3})}catch(e){console.error("Download failed:",e),this.isAuthError(e)?this.handleAuthError():this.toastsService.showAsError("Failed to download from Google Drive",{headerText:null,delayMs:5e3})}finally{this.isSyncing.set(!1)}}async gatherData(){let e=this.foodsService.foods(),t=this.recipesService.recipes(),i=this.diaryLogService.diaryLog(),o=this.optionsService.options(),s=new Set;for(let d of t)d.imageId&&s.add(d.imageId);if(i?.diaryDays)for(let d of i.diaryDays)for(let f of d.dayTemplate.entries)f.meal.imageId&&s.add(f.meal.imageId);let a=[];for(let d of s){let f=await this.imageStoreService.get(d);f&&a.push({imageId:d,base64:f})}return{foods:e,recipes:t,diaryLog:i,options:o,images:a}}async restoreData(e){if(e.foods&&this.foodsService.setFoods(e.foods),e.recipes&&this.recipesService.setRecipes(e.recipes),e.diaryLog&&this.diaryLogService.setDiary(e.diaryLog),e.options&&this.optionsService.setOptions(e.options),e.images)for(let t of e.images){let i=t.base64.replace(/^data:image\/[^;]+;base64,/,"");await this.imageStoreService.put(t.imageId,i)}}async findDataFile(){let e=await fetch(`https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&q=name='${q}'&fields=files(id,name)`,{headers:{Authorization:`Bearer ${this.accessToken}`}});return await F(e),(await e.json()).files?.[0]?.id??null}async createFile(e){let t={name:q,parents:["appDataFolder"],mimeType:"application/json"},i=new FormData;i.append("metadata",new Blob([JSON.stringify(t)],{type:"application/json"})),i.append("file",new Blob([JSON.stringify(e)],{type:"application/json"}));let o=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`},body:i});await F(o)}async updateFile(e,t){let i=await fetch(`https://www.googleapis.com/upload/drive/v3/files/${e}?uploadType=media`,{method:"PATCH",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify(t)});await F(i)}async downloadFile(e){let t=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?alt=media`,{headers:{Authorization:`Bearer ${this.accessToken}`}});return await F(t),t.json()}isAuthError(e){return e instanceof A&&e.status===401}handleAuthError(){this.accessToken=null,this.userEmail.set(null),this.clearToken(),this.isSignedIn.set(!1),this.toastsService.showAsWarning("Google session expired. Please sign in again.",{headerText:null,delayMs:5e3})}async getUserEmail(e){try{let t=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${e}`}});return t.ok?(await t.json()).email:void 0}catch{return}}static \u0275fac=function(t){return new(t||c)};static \u0275prov=O({token:c,factory:c.\u0275fac,providedIn:"root"})};var Z=["jsonUploadFoods"],ee=["jsonUploadRecipes"],te=["jsonUploadDiary"],H=(c,e)=>({"btn-secondary":c,"btn-outline-secondary":e});function ie(c,e){if(c&1){let t=w();n(0,"button",18),m("click",function(){u(t);let o=y();return g(o.googleDriveService.signIn())}),l(1," Sign in with Google "),r()}}function oe(c,e){if(c&1){let t=w();n(0,"button",19),m("click",function(){u(t);let o=y();return g(o.googleDriveService.uploadToDrive())}),l(1," Upload to Drive "),r(),n(2,"button",20),m("click",function(){u(t);let o=y();return g(o.googleDriveService.downloadFromDrive())}),l(3," Download from Drive "),r(),n(4,"div",21),l(5),r(),n(6,"button",22),m("click",function(){u(t);let o=y();return g(o.googleDriveService.signOut())}),l(7," Sign out "),r()}if(c&2){let t=y();j(M(7,H,!t.googleDriveService.isSyncing(),t.googleDriveService.isSyncing())),h("disabled",t.googleDriveService.isSyncing()),v(2),j(M(10,H,!t.googleDriveService.isSyncing(),t.googleDriveService.isSyncing())),h("disabled",t.googleDriveService.isSyncing()),v(3),N(t.googleDriveService.userEmail())}}var Q=class c{toastsService=p(E);foodsService=p(x);recipesService=p(k);diaryLogService=p(T);imageStoreService=p(I);googleDriveService=p(L);jsonUploadFoodsInput=D("jsonUploadFoods");onLoadFoodsFromFile(e){let t=e.target;if(t.files?.length!==1){this.jsonUploadFoodsInput().nativeElement.value="";return}let i=t.files?.[0],o=new FileReader;o.onload=s=>{let a=s.target?.result;if(a){let d=JSON.parse(a);if(!Array.isArray(d)||!d.every(f=>W(f))){this.toastsService.showAsWarning("Wrong food data",{headerText:null,delayMs:5e3}),console.warn("Wrong food data");return}if(this.foodsService.setFoods(d),this.foodsService.foods()?.length===1){this.toastsService.showAsInformation("Loaded 1 food",{headerText:null,delayMs:5e3});return}this.toastsService.showAsInformation(`Loaded ${this.foodsService.foods()?.length} foods`,{headerText:null,delayMs:5e3})}},o.readAsText(i),this.jsonUploadFoodsInput().nativeElement.value=""}jsonUploadRecipesInput=D("jsonUploadRecipes");onLoadRecipesFromFile(e){let t=e.target;if(t.files?.length!==1){this.jsonUploadRecipesInput().nativeElement.value="";return}let i=t.files?.[0],o=new FileReader;o.onload=s=>{let a=s.target?.result;if(a){let d=JSON.parse(a);if(!Array.isArray(d)||!d.every(f=>B(f))){this.toastsService.showAsWarning("Wrong recipes data",{headerText:null,delayMs:5e3}),console.warn("Wrong recipes data");return}if(this.recipesService.setRecipes(d),this.recipesService.recipes()?.length===1){this.toastsService.showAsInformation("Loaded 1 recipe",{headerText:null,delayMs:5e3});return}this.toastsService.showAsInformation(`Loaded ${this.recipesService.recipes()?.length} recipes`,{headerText:null,delayMs:5e3})}},o.readAsText(i),this.jsonUploadRecipesInput().nativeElement.value=""}jsonUploadDiaryInput=D("jsonUploadDiary");onLoadDiaryFromFile(e){let t=e.target;if(t.files?.length!==1){this.jsonUploadDiaryInput().nativeElement.value="";return}let i=t.files?.[0],o=new FileReader;o.onload=s=>{let a=s.target?.result;if(a){let d=JSON.parse(a);if(!Array.isArray(d.diaryDays)){this.toastsService.showAsWarning("Wrong diary data",{headerText:null,delayMs:5e3}),console.warn("Wrong diary data");return}if(this.diaryLogService.setDiary(d),this.diaryLogService.diaryLog()?.diaryDays?.length===1){this.toastsService.showAsInformation("Loaded 1 diary day",{headerText:null,delayMs:5e3});return}this.toastsService.showAsInformation(`Loaded ${this.diaryLogService.diaryLog()?.diaryDays?.length} diary days`,{headerText:null,delayMs:5e3})}},o.readAsText(i),this.jsonUploadDiaryInput().nativeElement.value=""}router=p(G);clearAllMemory(){localStorage.clear(),this.imageStoreService.deleteDatabase(),this.router.navigate([z.home]),setTimeout(()=>{window.location.reload()},50)}static \u0275fac=function(t){return new(t||c)};static \u0275cmp=V({type:c,selectors:[["app-options"]],viewQuery:function(t,i){t&1&&U(i.jsonUploadFoodsInput,Z,5)(i.jsonUploadRecipesInput,ee,5)(i.jsonUploadDiaryInput,te,5),t&2&&P(3)},decls:48,vars:7,consts:[["jsonUploadFoods",""],["jsonUploadRecipes",""],["jsonUploadDiary",""],[1,"content-wrapper"],[1,"border","rounded","m-1","mb-0"],[1,"mx-1"],[1,"d-flex","justify-content-between","p-1","bg-body-tertiary"],["iconSize","24px","buttonIcon","iconoir:save-floppy-disk",1,"btn","btn-outline-secondary","p-0","px-1","rounded-0",3,"click","disabled"],["type","file","accept",".json",1,"d-none",3,"change"],["iconSize","24px","buttonIcon","iconoir:load-action-floppy",1,"btn","btn-outline-secondary","p-0","px-1","rounded-0",3,"click"],[1,"mx-1","d-flex","justify-content-between","align-items-center"],[1,"text-muted","fst-italic","opacity-75",2,"font-size","10px"],[1,"d-flex","flex-column","gap-1","p-1","bg-body-tertiary"],["iconSize","24px","buttonIcon","iconoir:google",1,"btn","btn-secondary","p-0","px-1","rounded","opacity-75"],[1,"border","rounded","m-1","mb-0","bg-warning-subtle"],[1,"d-flex","flex-column","align-items-center","p-1","pt-0","bg-body-tertiary"],[1,"p-1","text-warning",2,"font-size","12px"],["iconSize","24px","buttonIcon","grommet-icons:clear",1,"btn","btn-outline-warning","p-0","px-1","opacity-25",3,"click"],["iconSize","24px","buttonIcon","iconoir:google",1,"btn","btn-secondary","p-0","px-1","rounded","opacity-75",3,"click"],["iconSize","24px","buttonIcon","iconoir:cloud-upload",1,"btn","p-0","px-1","rounded","opacity-40",3,"click","disabled"],["iconSize","24px","buttonIcon","iconoir:cloud-download",1,"btn","p-0","px-1","rounded","opacity-40",3,"click","disabled"],[1,"mt-4","text-muted","text-truncate","fst-italic","opacity-40",2,"font-size","14px","line-height","16px"],["iconSize","24px","buttonIcon","iconoir:log-out",1,"btn","btn-secondary","p-0","px-1","rounded","opacity-75",3,"click"]],template:function(t,i){if(t&1){let o=w();n(0,"div",3)(1,"div",4)(2,"div",5),l(3,"Foods"),r(),n(4,"div",6)(5,"button",7),m("click",function(){return u(o),g(i.foodsService.downloadFoods())}),l(6),r(),n(7,"input",8,0),m("change",function(a){return u(o),g(i.onLoadFoodsFromFile(a))}),r(),n(9,"button",9),m("click",function(){u(o);let a=_(8);return g(a.click())}),l(10," Load "),r()()(),n(11,"div",4)(12,"div",5),l(13,"Recipes"),r(),n(14,"div",6)(15,"button",7),m("click",function(){return u(o),g(i.recipesService.downloadRecipes())}),l(16),r(),n(17,"input",8,1),m("change",function(a){return u(o),g(i.onLoadRecipesFromFile(a))}),r(),n(19,"button",9),m("click",function(){u(o);let a=_(18);return g(a.click())}),l(20," Load "),r()()(),n(21,"div",4)(22,"div",10)(23,"div"),l(24,"Main diary"),r(),n(25,"span",11),l(26,"*Images will be skipped"),r()(),n(27,"div",6)(28,"button",7),m("click",function(){return u(o),g(i.diaryLogService.downloadDiary())}),l(29),r(),n(30,"input",8,2),m("change",function(a){return u(o),g(i.onLoadDiaryFromFile(a))}),r(),n(32,"button",9),m("click",function(){u(o);let a=_(31);return g(a.click())}),l(33," Load "),r()()(),n(34,"div",4)(35,"div",5),l(36,"Google Drive sync"),r(),n(37,"div",12),C(38,ie,2,0,"button",13)(39,oe,8,13),r()(),n(40,"div",14)(41,"div",5),l(42,"Storage reset"),r(),n(43,"div",15)(44,"div",16),l(45," Make sure you saved your data before clearing... "),r(),n(46,"button",17),m("click",function(){return u(o),g(i.clearAllMemory())}),l(47," Clear all memory! "),r()()()()}if(t&2){let o,s;v(5),h("disabled",!i.foodsService.foods().length),v(),b(" Save (",i.foodsService.foods().length,") "),v(9),h("disabled",!i.recipesService.recipes().length),v(),b(" Save (",i.recipesService.recipes().length,") "),v(12),h("disabled",!(!((o=i.diaryLogService.diaryLog())==null||o.diaryDays==null)&&o.diaryDays.length)),v(),b(" Save (",((s=i.diaryLogService.diaryLog())==null||s.diaryDays==null?null:s.diaryDays.length)||0,") "),v(9),R(i.googleDriveService.isSignedIn()?39:38)}},dependencies:[$],encapsulation:2})};export{Q as Options};
