import{a as k}from"./chunk-FVGU5N2M.js";import{a as W}from"./chunk-UEJSXAPY.js";import{a as I}from"./chunk-2KTHP7SW.js";import{a as D,e as G,f as N,r as z,u as x,v as T}from"./chunk-KHSIFIAT.js";import"./chunk-P7OX43DN.js";import{l as U,t as P}from"./chunk-ZO3AIT2L.js";import"./chunk-TTUD5ZDE.js";import{Fb as m,Ga as f,Hb as y,Ob as C,Pb as R,Qb as w,Vb as l,X as j,Xa as M,Xb as _,aa as p,fa as u,ga as g,jb as O,kb as V,pb as h,qb as s,ra as L,rb as a,sc as b,yb as S}from"./chunk-HXGKTDM5.js";var A=class extends Error{constructor(t,i){super(t);this.status=i}};async function F(d){if(!d.ok){let e=await d.text().catch(()=>"");throw new A(e||d.statusText,d.status)}}var J="875660427890-lqom4d5625fslef32gvcrlc972qefi13.apps.googleusercontent.com",H="https://www.googleapis.com/auth/drive.appdata",$="food-fetish-data.json",E=class d{foodsService=p(D);recipesService=p(T);diaryLogService=p(x);optionsService=p(W);imageStoreService=p(I);toastsService=p(k);accessToken=null;tokenClient=null;isSignedIn=L(!1);isSyncing=L(!1);gisLoaded=!1;loadGisScript(){return this.gisLoaded?Promise.resolve():new Promise((e,t)=>{if(document.querySelector('script[src*="accounts.google.com/gsi/client"]')){this.gisLoaded=!0,e();return}let i=document.createElement("script");i.src="https://accounts.google.com/gsi/client",i.async=!0,i.defer=!0,i.onload=()=>{this.gisLoaded=!0,e()},i.onerror=()=>t(new Error("Failed to load Google Identity Services")),document.head.appendChild(i)})}async signIn(){try{await this.loadGisScript()}catch{this.toastsService.showAsError("Failed to load Google services",{headerText:null,delayMs:5e3});return}return new Promise(e=>{this.tokenClient=google.accounts.oauth2.initTokenClient({client_id:J,scope:H,callback:t=>{if(t.error){this.toastsService.showAsError("Google sign-in failed",{headerText:null,delayMs:5e3}),e();return}this.accessToken=t.access_token??null,this.isSignedIn.set(!0),this.toastsService.showAsSuccess("Signed in to Google Drive",{headerText:null,delayMs:3e3}),e()}}),this.tokenClient.requestAccessToken()})}signOut(){this.accessToken=null,this.isSignedIn.set(!1),this.toastsService.showAsInformation("Signed out from Google Drive",{headerText:null,delayMs:3e3})}async uploadToDrive(){if(!this.accessToken){this.toastsService.showAsWarning("Not signed in to Google Drive",{headerText:null,delayMs:5e3});return}this.isSyncing.set(!0);try{let e=await this.gatherData(),t=await this.findDataFile();t?await this.updateFile(t,e):await this.createFile(e),this.toastsService.showAsSuccess("Data uploaded to Google Drive",{headerText:null,delayMs:3e3})}catch(e){console.error("Upload failed:",e),this.isAuthError(e)?this.handleAuthError():this.toastsService.showAsError("Failed to upload to Google Drive",{headerText:null,delayMs:5e3})}finally{this.isSyncing.set(!1)}}async downloadFromDrive(){if(!this.accessToken){this.toastsService.showAsWarning("Not signed in to Google Drive",{headerText:null,delayMs:5e3});return}this.isSyncing.set(!0);try{let e=await this.findDataFile();if(!e){this.toastsService.showAsWarning("No data found on Google Drive",{headerText:null,delayMs:5e3});return}let t=await this.downloadFile(e);await this.restoreData(t),this.toastsService.showAsSuccess("Data downloaded from Google Drive",{headerText:null,delayMs:3e3})}catch(e){console.error("Download failed:",e),this.isAuthError(e)?this.handleAuthError():this.toastsService.showAsError("Failed to download from Google Drive",{headerText:null,delayMs:5e3})}finally{this.isSyncing.set(!1)}}async gatherData(){let e=this.foodsService.foods(),t=this.recipesService.recipes(),i=this.diaryLogService.diaryLog(),o=this.optionsService.options(),n=new Set;for(let c of t)c.imageId&&n.add(c.imageId);if(i?.diaryDays)for(let c of i.diaryDays)for(let v of c.dayTemplate.entries)v.meal.imageId&&n.add(v.meal.imageId);let r=[];for(let c of n){let v=await this.imageStoreService.get(c);v&&r.push({imageId:c,base64:v})}return{foods:e,recipes:t,diaryLog:i,options:o,images:r}}async restoreData(e){if(e.foods&&this.foodsService.setFoods(e.foods),e.recipes&&this.recipesService.setRecipes(e.recipes),e.diaryLog&&this.diaryLogService.setDiary(e.diaryLog),e.options&&this.optionsService.setOptions(e.options),e.images)for(let t of e.images){let i=t.base64.replace(/^data:image\/[^;]+;base64,/,"");await this.imageStoreService.put(t.imageId,i)}}async findDataFile(){let e=await fetch(`https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&q=name='${$}'&fields=files(id,name)`,{headers:{Authorization:`Bearer ${this.accessToken}`}});return await F(e),(await e.json()).files?.[0]?.id??null}async createFile(e){let t={name:$,parents:["appDataFolder"],mimeType:"application/json"},i=new FormData;i.append("metadata",new Blob([JSON.stringify(t)],{type:"application/json"})),i.append("file",new Blob([JSON.stringify(e)],{type:"application/json"}));let o=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`},body:i});await F(o)}async updateFile(e,t){let i=await fetch(`https://www.googleapis.com/upload/drive/v3/files/${e}?uploadType=media`,{method:"PATCH",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify(t)});await F(i)}async downloadFile(e){let t=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?alt=media`,{headers:{Authorization:`Bearer ${this.accessToken}`}});return await F(t),t.json()}isAuthError(e){return e instanceof A&&e.status===401}handleAuthError(){this.accessToken=null,this.isSignedIn.set(!1),this.toastsService.showAsWarning("Google session expired. Please sign in again.",{headerText:null,delayMs:5e3})}static \u0275fac=function(t){return new(t||d)};static \u0275prov=j({token:d,factory:d.\u0275fac,providedIn:"root"})};var Q=["jsonUploadFoods"],K=["jsonUploadRecipes"],X=["jsonUploadDiary"];function Y(d,e){if(d&1){let t=S();s(0,"button",18),m("click",function(){u(t);let o=y();return g(o.googleDriveService.signIn())}),l(1," Sign in with Google "),a()}}function Z(d,e){if(d&1){let t=S();s(0,"button",19),m("click",function(){u(t);let o=y();return g(o.googleDriveService.uploadToDrive())}),l(1," Upload to Drive "),a(),s(2,"button",20),m("click",function(){u(t);let o=y();return g(o.googleDriveService.downloadFromDrive())}),l(3," Download from Drive "),a(),s(4,"button",21),m("click",function(){u(t);let o=y();return g(o.googleDriveService.signOut())}),l(5," Sign out "),a()}if(d&2){let t=y();h("disabled",t.googleDriveService.isSyncing()),f(2),h("disabled",t.googleDriveService.isSyncing())}}var q=class d{toastsService=p(k);foodsService=p(D);recipesService=p(T);diaryLogService=p(x);imageStoreService=p(I);googleDriveService=p(E);jsonUploadFoodsInput=b("jsonUploadFoods");onLoadFoodsFromFile(e){let t=e.target;if(t.files?.length!==1){this.jsonUploadFoodsInput().nativeElement.value="";return}let i=t.files?.[0],o=new FileReader;o.onload=n=>{let r=n.target?.result;if(r){let c=JSON.parse(r);if(!Array.isArray(c)||!c.every(v=>G(v))){this.toastsService.showAsWarning("Wrong food data",{headerText:null,delayMs:5e3}),console.warn("Wrong food data");return}if(this.foodsService.setFoods(c),this.foodsService.foods()?.length===1){this.toastsService.showAsInformation("Loaded 1 food",{headerText:null,delayMs:5e3});return}this.toastsService.showAsInformation(`Loaded ${this.foodsService.foods()?.length} foods`,{headerText:null,delayMs:5e3})}},o.readAsText(i),this.jsonUploadFoodsInput().nativeElement.value=""}jsonUploadRecipesInput=b("jsonUploadRecipes");onLoadRecipesFromFile(e){let t=e.target;if(t.files?.length!==1){this.jsonUploadRecipesInput().nativeElement.value="";return}let i=t.files?.[0],o=new FileReader;o.onload=n=>{let r=n.target?.result;if(r){let c=JSON.parse(r);if(!Array.isArray(c)||!c.every(v=>z(v))){this.toastsService.showAsWarning("Wrong recipes data",{headerText:null,delayMs:5e3}),console.warn("Wrong recipes data");return}if(this.recipesService.setRecipes(c),this.recipesService.recipes()?.length===1){this.toastsService.showAsInformation("Loaded 1 recipe",{headerText:null,delayMs:5e3});return}this.toastsService.showAsInformation(`Loaded ${this.recipesService.recipes()?.length} recipes`,{headerText:null,delayMs:5e3})}},o.readAsText(i),this.jsonUploadRecipesInput().nativeElement.value=""}jsonUploadDiaryInput=b("jsonUploadDiary");onLoadDiaryFromFile(e){let t=e.target;if(t.files?.length!==1){this.jsonUploadDiaryInput().nativeElement.value="";return}let i=t.files?.[0],o=new FileReader;o.onload=n=>{let r=n.target?.result;if(r){let c=JSON.parse(r);if(!Array.isArray(c.diaryDays)){this.toastsService.showAsWarning("Wrong diary data",{headerText:null,delayMs:5e3}),console.warn("Wrong diary data");return}if(this.diaryLogService.setDiary(c),this.diaryLogService.diaryLog()?.diaryDays?.length===1){this.toastsService.showAsInformation("Loaded 1 diary day",{headerText:null,delayMs:5e3});return}this.toastsService.showAsInformation(`Loaded ${this.diaryLogService.diaryLog()?.diaryDays?.length} diary days`,{headerText:null,delayMs:5e3})}},o.readAsText(i),this.jsonUploadDiaryInput().nativeElement.value=""}router=p(U);clearAllMemory(){localStorage.clear(),this.imageStoreService.deleteDatabase(),this.router.navigate([P.home]),setTimeout(()=>{window.location.reload()},50)}static \u0275fac=function(t){return new(t||d)};static \u0275cmp=M({type:d,selectors:[["app-options"]],viewQuery:function(t,i){t&1&&C(i.jsonUploadFoodsInput,Q,5)(i.jsonUploadRecipesInput,K,5)(i.jsonUploadDiaryInput,X,5),t&2&&R(3)},decls:48,vars:7,consts:[["jsonUploadFoods",""],["jsonUploadRecipes",""],["jsonUploadDiary",""],[1,"content-wrapper"],[1,"border","rounded","m-1","mb-0"],[1,"mx-1"],[1,"d-flex","justify-content-between","p-1","bg-body-tertiary"],["iconSize","24px","buttonIcon","iconoir:save-floppy-disk",1,"btn","btn-outline-secondary","p-0","px-1","rounded-0",3,"click","disabled"],["type","file","accept",".json",1,"d-none",3,"change"],["iconSize","24px","buttonIcon","iconoir:load-action-floppy",1,"btn","btn-outline-secondary","p-0","px-1","rounded-0",3,"click"],[1,"mx-1","d-flex","justify-content-between","align-items-center"],[1,"text-muted","fst-italic","opacity-75",2,"font-size","10px"],[1,"d-flex","flex-column","gap-1","p-1","bg-body-tertiary"],["iconSize","24px","buttonIcon","iconoir:google",1,"btn","btn-outline-secondary","p-0","px-1","rounded-0"],[1,"border","rounded","m-1","mb-0","bg-warning-subtle"],[1,"d-flex","flex-column","align-items-center","p-1","pt-0","bg-body-tertiary"],[1,"p-1","text-warning",2,"font-size","12px"],["iconSize","24px","buttonIcon","grommet-icons:clear",1,"btn","btn-outline-warning","p-0","px-1","opacity-25",3,"click"],["iconSize","24px","buttonIcon","iconoir:google",1,"btn","btn-outline-secondary","p-0","px-1","rounded-0",3,"click"],["iconSize","24px","buttonIcon","iconoir:cloud-upload",1,"btn","btn-outline-secondary","p-0","px-1","rounded-0",3,"click","disabled"],["iconSize","24px","buttonIcon","iconoir:cloud-download",1,"btn","btn-outline-secondary","p-0","px-1","rounded-0",3,"click","disabled"],["iconSize","24px","buttonIcon","iconoir:log-out",1,"btn","btn-outline-secondary","p-0","px-1","rounded-0",3,"click"]],template:function(t,i){if(t&1){let o=S();s(0,"div",3)(1,"div",4)(2,"div",5),l(3,"Foods"),a(),s(4,"div",6)(5,"button",7),m("click",function(){return u(o),g(i.foodsService.downloadFoods())}),l(6),a(),s(7,"input",8,0),m("change",function(r){return u(o),g(i.onLoadFoodsFromFile(r))}),a(),s(9,"button",9),m("click",function(){u(o);let r=w(8);return g(r.click())}),l(10," Load "),a()()(),s(11,"div",4)(12,"div",5),l(13,"Recipes"),a(),s(14,"div",6)(15,"button",7),m("click",function(){return u(o),g(i.recipesService.downloadRecipes())}),l(16),a(),s(17,"input",8,1),m("change",function(r){return u(o),g(i.onLoadRecipesFromFile(r))}),a(),s(19,"button",9),m("click",function(){u(o);let r=w(18);return g(r.click())}),l(20," Load "),a()()(),s(21,"div",4)(22,"div",10)(23,"div"),l(24,"Main diary"),a(),s(25,"span",11),l(26,"*Images will be skipped"),a()(),s(27,"div",6)(28,"button",7),m("click",function(){return u(o),g(i.diaryLogService.downloadDiary())}),l(29),a(),s(30,"input",8,2),m("change",function(r){return u(o),g(i.onLoadDiaryFromFile(r))}),a(),s(32,"button",9),m("click",function(){u(o);let r=w(31);return g(r.click())}),l(33," Load "),a()()(),s(34,"div",4)(35,"div",5),l(36,"Google Drive sync"),a(),s(37,"div",12),O(38,Y,2,0,"button",13)(39,Z,6,2),a()(),s(40,"div",14)(41,"div",5),l(42,"Storage reset"),a(),s(43,"div",15)(44,"div",16),l(45," Make sure you saved your data before clearing... "),a(),s(46,"button",17),m("click",function(){return u(o),g(i.clearAllMemory())}),l(47," Clear all memory! "),a()()()()}if(t&2){let o,n;f(5),h("disabled",!i.foodsService.foods().length),f(),_(" Save (",i.foodsService.foods().length,") "),f(9),h("disabled",!i.recipesService.recipes().length),f(),_(" Save (",i.recipesService.recipes().length,") "),f(12),h("disabled",!(!((o=i.diaryLogService.diaryLog())==null||o.diaryDays==null)&&o.diaryDays.length)),f(),_(" Save (",((n=i.diaryLogService.diaryLog())==null||n.diaryDays==null?null:n.diaryDays.length)||0,") "),f(9),V(i.googleDriveService.isSignedIn()?39:38)}},dependencies:[N],encapsulation:2})};export{q as Options};
