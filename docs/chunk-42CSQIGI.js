import{a as T}from"./chunk-UEJSXAPY.js";import{a as S}from"./chunk-2KTHP7SW.js";import{b as c,c as v,v as y,w}from"./chunk-G7KJV4CT.js";import{X as p,a as l,aa as r,ra as n}from"./chunk-HXGKTDM5.js";var g=class i{toasts=n([]);toastMessageTypeDefinitions={error:{className:"bg-danger-subtle"},warning:{className:"bg-warning-subtle"},success:{className:"bg-success-subtle"},information:{className:"bg-info-subtle"}};showAsError(e,t){this.show(l({id:c(),textOrTpl:e,toastType:"error"},t))}showAsWarning(e,t){this.show(l({id:c(),textOrTpl:e,toastType:"warning"},t))}showAsSuccess(e,t){this.show(l({id:c(),textOrTpl:e,toastType:"success"},t))}showAsInformation(e,t){this.show(l({id:c(),textOrTpl:e,toastType:"information"},t))}show(e){if(!e.textOrTpl)return;let t=e.toastType??"information";this.toasts.update(s=>[...s,l({id:c(),className:this.toastMessageTypeDefinitions[t].className,headerText:t},e)])}remove(e){this.toasts.update(t=>t.filter(s=>s!==e))}clear(){this.toasts.update(e=>e.filter(t=>t?.isClearIgnored))}static \u0275fac=function(t){return new(t||i)};static \u0275prov=p({token:i,factory:i.\u0275fac,providedIn:"root"})};var f=class extends Error{constructor(t,s){super(t);this.status=s}};async function u(i){if(!i.ok){let e=await i.text().catch(()=>"");throw new f(e||i.statusText,i.status)}}var F="875660427890-lqom4d5625fslef32gvcrlc972qefi13.apps.googleusercontent.com",x="https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/userinfo.email",D="food-fetish-data.json",k=class i{foodsService=r(v);recipesService=r(w);diaryLogService=r(y);optionsService=r(T);imageStoreService=r(S);toastsService=r(g);accessToken=null;tokenClient=null;isSignedIn=n(!1);isSyncing=n(!1);syncFailed=n(!1);userEmail=n(null);gisLoaded=!1;constructor(){this.restoreToken()}restoreToken(){let e=localStorage.getItem("google_token_data");if(e){let t=JSON.parse(e);this.isTokenExpired(t.expiry)?this.clearToken():(this.accessToken=t.token,this.userEmail.set(t.email??null),this.isSignedIn.set(!0))}}saveToken(e,t,s){let o={token:e};t&&(o.expiry=Date.now()+t*1e3),s&&(o.email=s),localStorage.setItem("google_token_data",JSON.stringify(o))}isTokenExpired(e){return e?Date.now()>e:!1}clearToken(){localStorage.removeItem("google_token_data")}loadGisScript(){return this.gisLoaded?Promise.resolve():new Promise((e,t)=>{if(document.querySelector('script[src*="accounts.google.com/gsi/client"]')){this.gisLoaded=!0,e();return}let s=document.createElement("script");s.src="https://accounts.google.com/gsi/client",s.async=!0,s.defer=!0,s.onload=()=>{this.gisLoaded=!0,e()},s.onerror=()=>t(new Error("Failed to load Google Identity Services")),document.head.appendChild(s)})}async signIn(){try{await this.loadGisScript()}catch{this.toastsService.showAsError("Failed to load Google services",{headerText:null,delayMs:5e3});return}return new Promise(e=>{this.tokenClient=google.accounts.oauth2.initTokenClient({client_id:F,scope:x,callback:async t=>{if(t.error){this.toastsService.showAsError("Google sign-in failed",{headerText:null,delayMs:5e3}),e();return}if(this.accessToken=t.access_token??null,this.accessToken){let s=await this.getUserEmail(this.accessToken);this.userEmail.set(s??null),this.saveToken(this.accessToken,t.expires_in,s)}this.isSignedIn.set(!0),this.toastsService.showAsSuccess("Signed in to Google Drive",{headerText:null,delayMs:3e3}),await this.loadFromDrive(),e()}}),this.tokenClient.requestAccessToken()})}signOut(){this.accessToken=null,this.userEmail.set(null),this.clearToken(),this.isSignedIn.set(!1),this.toastsService.showAsInformation("Signed out from Google Drive",{headerText:null,delayMs:3e3})}async uploadToDrive(){if(!this.accessToken){this.toastsService.showAsWarning("Not signed in to Google Drive",{headerText:null,delayMs:5e3});return}this.isSyncing.set(!0);try{let e=await this.gatherData(),t=await this.findDataFile();t?await this.updateFile(t,e):await this.createFile(e),this.toastsService.showAsSuccess("Data uploaded to Google Drive",{headerText:null,delayMs:3e3})}catch(e){console.error("Upload failed:",e),this.isAuthError(e)?this.handleAuthError():this.toastsService.showAsError("Failed to upload to Google Drive",{headerText:null,delayMs:5e3})}finally{this.isSyncing.set(!1)}}async saveToDrive(){if(this.syncFailed.set(!1),!(!this.accessToken||this.isSyncing())){this.isSyncing.set(!0);try{let e=0,t=await this.findDataFile();t&&(e=(await this.downloadFile(t)).metadata?.version??0);let s=this.getLocalVersion();if(e>s)return;let o=await this.gatherData();s++,o.metadata={version:s},t?await this.updateFile(t,o):await this.createFile(o),this.setLocalVersion(s)}catch(e){console.error("Upload failed:",e),this.isAuthError(e)?this.handleAuthError():this.toastsService.showAsError("Failed to upload to Google Drive",{headerText:null,delayMs:5e3}),this.syncFailed.set(!0)}finally{this.isSyncing.set(!1)}}}async loadFromDrive(){if(!(!this.accessToken||this.isSyncing())){this.isSyncing.set(!0);try{let e=await this.findDataFile();if(!e)return;let t=await this.downloadFile(e);await this.restoreData(t),t.metadata?.version&&this.setLocalVersion(t.metadata.version)}catch(e){console.error("Download failed:",e),this.isAuthError(e)?this.handleAuthError():this.toastsService.showAsError("Failed to download from Google Drive",{headerText:null,delayMs:5e3}),this.syncFailed.set(!0)}finally{this.isSyncing.set(!1)}}}async downloadFromDrive(){if(!this.accessToken){this.toastsService.showAsWarning("Not signed in to Google Drive",{headerText:null,delayMs:5e3});return}this.isSyncing.set(!0);try{let e=await this.findDataFile();if(!e){this.toastsService.showAsWarning("No data found on Google Drive",{headerText:null,delayMs:5e3});return}let t=await this.downloadFile(e);await this.restoreData(t),this.toastsService.showAsSuccess("Data downloaded from Google Drive",{headerText:null,delayMs:3e3})}catch(e){console.error("Download failed:",e),this.isAuthError(e)?this.handleAuthError():this.toastsService.showAsError("Failed to download from Google Drive",{headerText:null,delayMs:5e3})}finally{this.isSyncing.set(!1)}}async gatherData(){let e=this.foodsService.foods(),t=this.recipesService.recipes(),s=this.diaryLogService.diaryLog(),o=this.optionsService.options(),h=new Set;for(let a of t)a.imageId&&h.add(a.imageId);if(s?.diaryDays)for(let a of s.diaryDays)for(let d of a.dayTemplate.entries)d.meal.imageId&&h.add(d.meal.imageId);let m=[];for(let a of h){let d=await this.imageStoreService.get(a);d&&m.push({imageId:a,base64:d})}return{foods:e,recipes:t,diaryLog:s,options:o,images:m}}async restoreData(e){e.foods&&this.foodsService.setFoods(e.foods),e.recipes&&this.recipesService.setRecipes(e.recipes),e.diaryLog&&this.diaryLogService.setDiary(e.diaryLog),e.options&&this.optionsService.setOptions(e.options),await this.imageStoreService.deleteDatabase().then(async()=>{if(e.images)for(let t of e.images)await this.imageStoreService.put(t.imageId,t.base64)})}async findDataFile(){let e=await fetch(`https://www.googleapis.com/drive/v3/files?spaces=appDataFolder&q=name='${D}'&fields=files(id,name)`,{headers:{Authorization:`Bearer ${this.accessToken}`}});return await u(e),(await e.json()).files?.[0]?.id??null}async createFile(e){let t={name:D,parents:["appDataFolder"],mimeType:"application/json"},s=new FormData;s.append("metadata",new Blob([JSON.stringify(t)],{type:"application/json"})),s.append("file",new Blob([JSON.stringify(e)],{type:"application/json"}));let o=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:{Authorization:`Bearer ${this.accessToken}`},body:s});await u(o)}async updateFile(e,t){let s=await fetch(`https://www.googleapis.com/upload/drive/v3/files/${e}?uploadType=media`,{method:"PATCH",headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"},body:JSON.stringify(t)});await u(s)}async downloadFile(e){let t=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?alt=media`,{headers:{Authorization:`Bearer ${this.accessToken}`}});return await u(t),t.json()}isAuthError(e){return e instanceof f&&e.status===401}handleAuthError(){this.accessToken=null,this.userEmail.set(null),this.clearToken(),this.isSignedIn.set(!1),this.toastsService.showAsWarning("Google session expired. Please sign in again.",{headerText:null,delayMs:5e3})}async getUserEmail(e){try{let t=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${e}`}});return t.ok?(await t.json()).email:void 0}catch{return}}getLocalVersion(){let e=localStorage.getItem("google_data_version");return e?parseInt(e):0}setLocalVersion(e){localStorage.setItem("google_data_version",e.toString())}static \u0275fac=function(t){return new(t||i)};static \u0275prov=p({token:i,factory:i.\u0275fac,providedIn:"root"})};export{g as a,k as b};
