<div class="content-wrapper">
  <div
    class="fst-italic text-muted bg-body-tertiary text-center fw-semibold opacity-75"
    style="font-size: 14px; line-height: 16px"
  >
    {{ selectedDayJs()?.toISOString() | date }}
  </div>
  <weekdays [(selectedDate)]="selectedDate" />
  <div class="border-bottom"></div>
  <div class="d-flex">
    <div style="width: 130px"></div>
    <div
      class="row g-0 flex-grow-1 fw-bold text-muted fst-italic opacity-25 bg-body-secondary"
      style="font-size: 12px"
    >
      <div class="col col-2 align-self-center text-center">P</div>
      <div class="col col-2 align-self-center text-center">C</div>
      <div class="col col-2 align-self-center text-center">Fa</div>
      <div class="col col-2 align-self-center text-center">Fi</div>
      <div class="col col-2 align-self-center text-center">KCal</div>
      <div class="col col-2 align-self-center text-center">G</div>
    </div>
  </div>
  <div class="border-bottom"></div>
  <div class="accordion accordion-flush" id="accordionFlush">
    @for (mealTemplateEntry of dayTemplateService.getDayTemplate()!.entries; track $index) {
      @let respectiveMeal = getRespectiveMeal(mealTemplateEntry.position);
      <div class="accordion-item">
        <h2 class="accordion-header d-flex align-items-center">
          <button
            class="accordion-button p-1 text-truncate text-muted fw-bold opacity-75 shadow-none"
            [class.collapsed]="!isMealExpanded(mealTemplateEntry.position)"
            type="button"
            data-bs-toggle="collapse"
            [attr.data-bs-target]="'#flush-collapse' + $index"
            (click)="toggleExpandedMeal(mealTemplateEntry.position)"
            style="width: 130px"
          >
            {{ mealPositionMap[mealTemplateEntry.position] }}
          </button>
          <div class="flex-grow-1 align-self-stretch">
            <div
              class="row g-0 h-100 fw-light fst-italic"
              [class]="{
                'bg-body-secondary': !isMealExpanded(mealTemplateEntry.position),
                'bg-dark-subtle': isMealExpanded(mealTemplateEntry.position),
              }"
              style="font-size: 12px; transition: background-color 0.3s"
            >
              @let positionStats = getPositionStats(mealTemplateEntry.position);
              <div class="col col-2 align-self-center text-center">
                {{ positionStats.proteins.toFixed() }}
              </div>
              <div class="col col-2 align-self-center text-center">
                {{ positionStats.carbs.toFixed() }}
              </div>
              <div class="col col-2 align-self-center text-center">
                {{ positionStats.fats.toFixed() }}
              </div>
              <div class="col col-2 align-self-center text-center">
                {{ positionStats.fiber.toFixed() }}
              </div>
              <div class="col col-2 align-self-center text-center">
                {{ positionStats.calories.toFixed() }}
              </div>
              <div class="col col-2 align-self-center text-center">
                {{ positionStats.weight.toFixed() }}
              </div>
            </div>
          </div>
        </h2>
        <div
          #collapsible
          [id]="'flush-collapse' + $index"
          class="accordion-collapse collapse bg-body-secondary rounded"
          [class.show]="isMealExpanded(mealTemplateEntry.position)"
          data-bs-parent="#accordionFlush"
        >
          @if (respectiveMeal) {
            <div class="d-flex align-items-center p-1 gap-1 bg-body-tertiary">
              <button
                class="btn btn-outline-secondary"
                [class.btn-outline-success]="respectiveMeal.note"
                buttonIcon="iconoir:notes"
                iconSize="16px"
                (click)="toggleEditMealNoteDialog(respectiveMeal.id, respectiveMeal.note)"
              ></button>
              <input
                class="form-control form-control-sm shadow-none text-center bg-dark-subtle"
                type="text"
                [value]="respectiveMeal.name"
                (input)="updateMealName(mealTemplateEntry.position, $event.target.value)"
              />
            </div>
          }

          @for (
            recipe of getRespectiveRecipes(mealTemplateEntry.position);
            track $index;
            let isOdd = $odd
          ) {
            <diary-recipe
              [recipe]="recipe"
              (updateFoodWeight)="
                updateRecipeFoodWeight(
                  mealTemplateEntry.position,
                  $index,
                  $event.foodIndex,
                  $event.newWeight
                )
              "
              (removeRecipe)="removeRecipeFromPosition(mealTemplateEntry.position, $index)"
            />
          }
          @for (food of respectiveMeal?.foods; track $index; let isOdd = $odd) {
            <food-row
              [food]="food"
              [isOdd]="isOdd"
              (removeFood)="removeFood(mealTemplateEntry.position, $index, respectiveMeal)"
              (updateFoodWeight)="updateFoodWeight(mealTemplateEntry.position, $index, $event)"
            />
          }
          <div class="p-1 bg-body-tertiary d-flex gap-1">
            <button
              class="btn btn-outline-primary btn-sm opacity-60 flex-grow-1"
              buttonIcon="pajamas:recipe"
              (click)="$event.stopPropagation(); addRecipe(mealTemplateEntry.position)"
              iconSize="24px"
            >
              Add recipe
            </button>
            <button
              class="btn btn-outline-success btn-sm opacity-80 flex-grow-1"
              buttonIcon="iconoir:lens-plus"
              (click)="$event.stopPropagation(); addFood(mealTemplateEntry.position)"
              iconSize="24px"
            >
              Add food
            </button>
          </div>
        </div>
      </div>
    }
  </div>
    <total-row [stats]="getDayStats()" [fixedDecimals]="0"/>
  <weight-in-bar [isoDate]="selectedDayJs().toISOString()" />
</div>

<ng-template #editMealNoteDialog>
  <textarea
    class="form-control form-control-sm meal-name-input text-center"
    rows="3"
    placeholder="Meal note"
    [value]="editNoteMeal()"
    (input)="updateMealNote(editNoteMealId(), $any($event.target).value)"
  ></textarea>
</ng-template>
